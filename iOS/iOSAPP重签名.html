<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Jorson的个人博客</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="欢迎来到Jorson的个人博客">
    
    <link rel="preload" href="/kw-blog/assets/css/0.styles.41f8f72f.css" as="style"><link rel="preload" href="/kw-blog/assets/js/app.b958d4e2.js" as="script"><link rel="preload" href="/kw-blog/assets/js/2.1e882bb7.js" as="script"><link rel="preload" href="/kw-blog/assets/js/6.5ec75146.js" as="script"><link rel="prefetch" href="/kw-blog/assets/js/10.16ab3e3f.js"><link rel="prefetch" href="/kw-blog/assets/js/11.c2fa39b1.js"><link rel="prefetch" href="/kw-blog/assets/js/12.a6ee2b4e.js"><link rel="prefetch" href="/kw-blog/assets/js/13.7801f0b4.js"><link rel="prefetch" href="/kw-blog/assets/js/14.4f9f6969.js"><link rel="prefetch" href="/kw-blog/assets/js/15.34c109c7.js"><link rel="prefetch" href="/kw-blog/assets/js/16.336c82c3.js"><link rel="prefetch" href="/kw-blog/assets/js/17.c461c0c5.js"><link rel="prefetch" href="/kw-blog/assets/js/18.672355b5.js"><link rel="prefetch" href="/kw-blog/assets/js/19.9b09ceb8.js"><link rel="prefetch" href="/kw-blog/assets/js/20.a5d0a3a0.js"><link rel="prefetch" href="/kw-blog/assets/js/21.89bf4e4e.js"><link rel="prefetch" href="/kw-blog/assets/js/22.8d895b93.js"><link rel="prefetch" href="/kw-blog/assets/js/23.c2b20fca.js"><link rel="prefetch" href="/kw-blog/assets/js/3.f163c3d7.js"><link rel="prefetch" href="/kw-blog/assets/js/4.78725ba6.js"><link rel="prefetch" href="/kw-blog/assets/js/5.3664bea7.js"><link rel="prefetch" href="/kw-blog/assets/js/7.c57989ef.js"><link rel="prefetch" href="/kw-blog/assets/js/8.67b977fe.js"><link rel="prefetch" href="/kw-blog/assets/js/9.2faab3a0.js">
    <link rel="stylesheet" href="/kw-blog/assets/css/0.styles.41f8f72f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/kw-blog/" class="home-link router-link-active"><!----> <span class="site-name">Jorson的个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/kw-blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://github.com/Jorson007" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://juejin.cn/user/2163471667175549" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/kw-blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://github.com/Jorson007" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://juejin.cn/user/2163471667175549" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端学习</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>iOS学习</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/kw-blog/iOS/生命周期.html" class="sidebar-link">iOS生命周期</a></li><li><a href="/kw-blog/iOS/模块化.html" class="sidebar-link">iOS模块化</a></li><li><a href="/kw-blog/iOS/OCLint.html" class="sidebar-link">OClint</a></li><li><a href="/kw-blog/iOS/二进制重排.html" class="sidebar-link">二进制重排</a></li><li><a href="/kw-blog/iOS/iOSAPP重签名.html" class="active sidebar-link">iOS APP重签名</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kw-blog/iOS/iOSAPP重签名.html#ios签名机制" class="sidebar-link">iOS签名机制</a></li><li class="sidebar-sub-header"><a href="/kw-blog/iOS/iOSAPP重签名.html#ipa包重签名" class="sidebar-link">ipa包重签名</a></li></ul></li><li><a href="/kw-blog/iOS/iOS应用瘦身.html" class="sidebar-link">iOS应用瘦身</a></li><li><a href="/kw-blog/iOS/performSelector最全解析.html" class="sidebar-link">iOS performSelector最全解析</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>swift</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Flutter学习</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法学习</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>图像相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>杂七杂八</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>最近在学习iOS逆向相关的技术，首先就是得了解签名与重签名。对于iOS开发者来说，重签名是一项比较重要的技能。</p> <h2 id="ios签名机制"><a href="#ios签名机制" class="header-anchor">#</a> iOS签名机制</h2> <p>在了解重签名之前，先来看一下ipa包的签名机制，如下图：</p> <p><img src="/kw-blog/assets/img/coderesign1.4d2a303e.png" alt="重签名"></p> <blockquote><p>流程如下：
1. Mac 钥匙串访问 在本地生成一对公私钥钥匙对，下面默认为公钥L、私钥L（L：Local）。</p></blockquote> <div class="language- extra-class"><pre><code>2. Apple已有一对公私钥钥匙对，私钥A在Apple后台，公钥A内置到每一台iOS设备终端（A：Apple）。

3. 上传公钥L至Apple后台，使用私钥A对公钥L进行数字签名生成签名证书.cer，同时使用私钥L对额外信息（使用什么证书打包、AppID、打包的App包含了哪些功能、可以在哪些设备上安装）进行签名生成描述文件Provisioning Profile，之后将.cer和Provisioning Profile下载安装到Mac机器上。

4. 编译打包app，选择签名证书.cer，打包指令会自动找到该证书对应的私钥L（能匹配是因为钥匙对是成对出现的，前提是本地必须已经存在L私钥，也就是p12的安装），然后使用私钥L对app进行签名。

5. 这些签名数据包含两部分：Mach-O可执行文件会把签名直接写入这个文件中，其他资源文件则会保存在_CodeSignature目录下。你可以将打包生成的.ipa文件另存为.zip，解压后对Payload文件夹中的.app文件右键、显示包内容，就可以看到签名数据。

6. 另外签名过程中对于App内包含的动态库以及插件（Plugins、Watch、Frameworks文件夹），每一个都会单独进行一次签名，并生成各自的Mach-O可执行文件和_CodeSignature。

7. 签名数据指代码内容、App包含的所有资源文件，只要其中有任何改动，都必须重新签名才有效。
打包的过程中会将描述文件Provisioning Profile命名为embedded.mobileprovision放入到打包app中。

8. 安装/启动，iOS设备使用内置的公钥A验证embedded.mobileprovision是否有效（设备是否在允许安装列表内），同时再次验证里面包含的.cer证书签名是否有效（证书过期与否）并取出公钥L。

9. embedded.mobileprovision验证通过，就使用公钥L解密验证app签名信息：AppID是否对应、权限开关是否跟app里的entitlements一致等等。
</code></pre></div><h2 id="ipa包重签名"><a href="#ipa包重签名" class="header-anchor">#</a> ipa包重签名</h2> <p>ipa包重签名主要针对的是非App Store的安装包，App Store分发最终是上传ipa文件到苹果后台审核，通过后使用Apple私钥加密，然后才能发布安装，不存在重签入侵的可能。而开发调试、AD-Hoc、In-House等分发途径生成的ipa包不存在苹果后台验证的步骤，这也就意味着你可以对任意的.app、 .ipa文件进行重签名。</p> <p>重签名过程</p> <p>step1: 从 https://www.dumpapp.com/ 该网站中下载你所需要的重签名软件ipa包；</p> <p>step2: xCode创建你的壳工程，比如我是用微信做测试，那么我就创建名为WeChat的工程；</p> <p>step3: 在工程目录中新建一个APP文件夹，将下载的ipa包放在该文件夹中，如下图所示：</p> <p><img src="/kw-blog/assets/img/codesign2.b36d35b5.png" alt="文件目录"></p> <p>step4: 从上图中我们看到工程目录下有一个appsign.sh脚本文件，实际上这是我们将重签名的步骤使用脚本一次执行完毕；</p> <p>step5: 用XCode打开工程，在Build Phases中添加脚本</p> <p><img src="/kw-blog/assets/img/coderesign4.52ab53bb.png" alt="脚本"></p> <p>step6: 运行工程，第一次会闪退，在运行一次即可。</p> <p>上面我们看到重签名的脚本如下：</p> <div class="language- extra-class"><pre class="language-text"><code>
    # ${SRCROOT} 它是工程文件所在的目录
    #资源文件夹
    ASSETS_PATH=&quot;${SRCROOT}/APP&quot;

    #ipa包路径
    TARGET_IPA_PATH=&quot;${ASSETS_PATH}/*.ipa&quot;

    #----------------------------------------
    # 1. 解压IPA到Temp下

    if [ ! -d &quot;$ASSETS_PATH/Payload/&quot; ]; then
        unzip -oqq &quot;$TARGET_IPA_PATH&quot; -d &quot;$ASSETS_PATH&quot;
    fi

    # 拿到解压的临时的APP的路径
    TEMP_APP_PATH=$(set -- &quot;$ASSETS_PATH/Payload/&quot;*.app;echo &quot;$1&quot;)
    # echo &quot;路径是:$TEMP_APP_PATH&quot;

    #----------------------------------------
    # 2. 将解压出来的.app拷贝进入工程下
    # BUILT_PRODUCTS_DIR 工程生成的APP包的路径
    # TARGET_NAME target名称
    TARGET_APP_PATH=&quot;$BUILT_PRODUCTS_DIR/$TARGET_NAME.app&quot;
    echo &quot;app路径:$TARGET_APP_PATH&quot;

    rm -rf &quot;$TARGET_APP_PATH&quot;
    mkdir -p &quot;$TARGET_APP_PATH&quot;
    cp -rf &quot;$TEMP_APP_PATH/&quot; &quot;$TARGET_APP_PATH&quot;

    #----------------------------------------
    # 3. 删除extension和WatchAPP.个人证书没法签名Extention
    rm -rf &quot;$TARGET_APP_PATH/PlugIns&quot;
    rm -rf &quot;$TARGET_APP_PATH/Watch&quot;

    #----------------------------------------
    # 4. 更新info.plist文件 CFBundleIdentifier
    #  设置:&quot;Set : KEY Value&quot; &quot;目标文件路径&quot;
    /usr/libexec/PlistBuddy -c &quot;Set :CFBundleIdentifier $PRODUCT_BUNDLE_IDENTIFIER&quot; &quot;$TARGET_APP_PATH/Info.plist&quot;

    #----------------------------------------
    # 5. 给MachO文件上执行权限
    # 拿到MachO文件的路径
    APP_BINARY=`plutil -convert xml1 -o - $TARGET_APP_PATH/Info.plist|grep -A1 Exec|tail -n1|cut -f2 -d\&gt;|cut -f1 -d\&lt;`
    #上可执行权限
    chmod +x &quot;$TARGET_APP_PATH/$APP_BINARY&quot;

    #----------------------------------------
    # 6. 重签名第三方 FrameWorks
    TARGET_APP_FRAMEWORKS_PATH=&quot;$TARGET_APP_PATH/Frameworks&quot;
    if [ -d &quot;$TARGET_APP_FRAMEWORKS_PATH&quot; ];
    then
    for FRAMEWORK in &quot;$TARGET_APP_FRAMEWORKS_PATH/&quot;*
    do

    #签名
    /usr/bin/codesign --force --sign &quot;$EXPANDED_CODE_SIGN_IDENTITY&quot; &quot;$FRAMEWORK&quot;
    done
    fi

</code></pre></div><p>至此iOS的重签名介绍完毕，同时附上一些关于重签名相关的优秀博客<br></p> <ul><li><a href="https://blog.csdn.net/iOSTeam37/article/details/122331504" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/iOSTeam37/article/details/122331504<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://huoshan.blog.csdn.net/article/details/71598459" target="_blank" rel="noopener noreferrer">https://huoshan.blog.csdn.net/article/details/71598459<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://blog.csdn.net/jishulaozhuanjia/article/details/104801290" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/jishulaozhuanjia/article/details/104801290<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/kw-blog/iOS/二进制重排.html" class="prev">
        二进制重排
      </a></span> <span class="next"><a href="/kw-blog/iOS/iOS应用瘦身.html">
        iOS应用瘦身
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/kw-blog/assets/js/app.b958d4e2.js" defer></script><script src="/kw-blog/assets/js/2.1e882bb7.js" defer></script><script src="/kw-blog/assets/js/6.5ec75146.js" defer></script>
  </body>
</html>
