<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>物理内存和虚拟内存 | Jorson的个人博客</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="欢迎来到Jorson的个人博客">
    
    <link rel="preload" href="/kw-blog/assets/css/0.styles.41f8f72f.css" as="style"><link rel="preload" href="/kw-blog/assets/js/app.b958d4e2.js" as="script"><link rel="preload" href="/kw-blog/assets/js/2.1e882bb7.js" as="script"><link rel="preload" href="/kw-blog/assets/js/4.78725ba6.js" as="script"><link rel="prefetch" href="/kw-blog/assets/js/10.16ab3e3f.js"><link rel="prefetch" href="/kw-blog/assets/js/11.c2fa39b1.js"><link rel="prefetch" href="/kw-blog/assets/js/12.a6ee2b4e.js"><link rel="prefetch" href="/kw-blog/assets/js/13.7801f0b4.js"><link rel="prefetch" href="/kw-blog/assets/js/14.4f9f6969.js"><link rel="prefetch" href="/kw-blog/assets/js/15.34c109c7.js"><link rel="prefetch" href="/kw-blog/assets/js/16.336c82c3.js"><link rel="prefetch" href="/kw-blog/assets/js/17.c461c0c5.js"><link rel="prefetch" href="/kw-blog/assets/js/18.672355b5.js"><link rel="prefetch" href="/kw-blog/assets/js/19.9b09ceb8.js"><link rel="prefetch" href="/kw-blog/assets/js/20.a5d0a3a0.js"><link rel="prefetch" href="/kw-blog/assets/js/21.89bf4e4e.js"><link rel="prefetch" href="/kw-blog/assets/js/22.8d895b93.js"><link rel="prefetch" href="/kw-blog/assets/js/23.c2b20fca.js"><link rel="prefetch" href="/kw-blog/assets/js/3.f163c3d7.js"><link rel="prefetch" href="/kw-blog/assets/js/5.3664bea7.js"><link rel="prefetch" href="/kw-blog/assets/js/6.5ec75146.js"><link rel="prefetch" href="/kw-blog/assets/js/7.c57989ef.js"><link rel="prefetch" href="/kw-blog/assets/js/8.67b977fe.js"><link rel="prefetch" href="/kw-blog/assets/js/9.2faab3a0.js">
    <link rel="stylesheet" href="/kw-blog/assets/css/0.styles.41f8f72f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/kw-blog/" class="home-link router-link-active"><!----> <span class="site-name">Jorson的个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/kw-blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://github.com/Jorson007" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://juejin.cn/user/2163471667175549" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/kw-blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://github.com/Jorson007" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://juejin.cn/user/2163471667175549" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端学习</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>iOS学习</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/kw-blog/iOS/生命周期.html" class="sidebar-link">iOS生命周期</a></li><li><a href="/kw-blog/iOS/模块化.html" class="sidebar-link">iOS模块化</a></li><li><a href="/kw-blog/iOS/OCLint.html" class="sidebar-link">OClint</a></li><li><a href="/kw-blog/iOS/二进制重排.html" class="active sidebar-link">二进制重排</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kw-blog/iOS/二进制重排.html#物理内存和虚拟内存" class="sidebar-link">物理内存和虚拟内存</a></li></ul></li><li><a href="/kw-blog/iOS/iOSAPP重签名.html" class="sidebar-link">iOS APP重签名</a></li><li><a href="/kw-blog/iOS/iOS应用瘦身.html" class="sidebar-link">iOS应用瘦身</a></li><li><a href="/kw-blog/iOS/performSelector最全解析.html" class="sidebar-link">iOS performSelector最全解析</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>swift</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Flutter学习</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法学习</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>图像相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>杂七杂八</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="物理内存和虚拟内存"><a href="#物理内存和虚拟内存" class="header-anchor">#</a> 物理内存和虚拟内存</h2> <blockquote><p>在早期的操作系统中，任何进程被加载到内存中运行时，都是按照顺序完全加载的。内存中的地址就是真实的物理地址，并且进程所需要的全部 指令和数据都是一次性加载到内存中。这样就会有出现两个明显的问题：
<strong>数据安全问题</strong>: 由于各个进程是按照顺序依次加载到内存中的，并且内存中的地址就是真实的物理地址。这样在一个进程中就可以内存地址偏移区访问到任意的内存空间，包括一些非当前进程的数据信息，这就导致进程本身的数据并不安全，给黑客造成了侵入的机会;
<strong>内存浪费</strong>: 由于每个进程都是完整加载的内存中的，所以随着进程的增多，内存的消耗会越来越严重，而事实上用户在同一时间操作用到一个进程，并且不太会一次性用到进进程中的所有功能，这就导致了严重的效率问题。
于是引入了虚拟内存来解决以上问题，为了解决内存浪费的问题，虚拟内存是通过分页的方式来管理，一个进程的虚拟内存由很多个分页组成，启动APP的时候只需要按需加载所需要的分页，而不用把这个进程的内存都加载进来，大大节省了物理内存空间。同时为了解决安全性的问题，虚拟内存中的分页与污泥内存的分页之间存在一定的映射关系，而这种映射关系不是由进程决定的，而是由系统生成的，系统会维护一张内存映射表，当进程启动时由CPU去寻找虚拟内存中分页所对应的物理内存。</p></blockquote> <p>传统进程与内存的关系：
<img src="/kw-blog/assets/img/chongpai1.e0946463.png" alt="传统"></p> <p>引入虚拟内存后进程与内存的关系：
<img src="/kw-blog/assets/img/chongpai2.4c2e56fe.png" alt="虚拟"></p> <p>采用虚拟内存后，CPU访问进程数据的流程如下:</p> <ol><li>进程启动后，系统会为进程建立一个对应的虚拟内存，里面记录了进程每项数据的虚拟内存地址，此时进程还未加载到物理内存中，所以page记录
的各项数据的物理内存地址为0x00000...。</li> <li>当进程的某部分活跃后，CPU根据这部分数据的虚拟内存地址找到其对应的物理内存地址，再通过物理地址访问到物理内存上的数据。</li> <li>如果在page上没有找到对应的物理地址时，说明此page上所关联的进程数据没被加载到物理内存中，此时会触发缺页异常（Page Fault），中断当前进程，先将当前页所对应的进程数据加载到物理内存中，然后page会记录每项数据的物理地址，CPU再通过物理地址来访问内存上的数据。</li></ol> <p>从上面的进程流程中我们可以看到，到CPU在page上没有找到物理内存会造成缺页异常，而这种异常会中断进程，直到该分页被加载到物理内存中。虽然缺页异常造成的终端时间微乎其微，但是如果缺页终端次数过多也会导致进程阻塞。那么如何减少缺页中断呢？</p> <p>首先我们知道APP在运行过程中其实很少会出现缺页异常的情况，只有在APP启动的时候需要为进程分配大量内存，如大量的方法调用和对象的初始化，这也就导致了APP启动时间变长。如果我们可以在APP启动过程中尽可能将调用的方法集中在较少的分页上，就会减少缺页中断的触发次数，也就能简短APP的启动时间。</p> <p>在进行缺页中断优化之前，我们首先要知道我们APP在启动过程中出现了多少次缺页异常。
那么就需要用到Instruments工具箱里面的System Trace，该工具可用来查看APP启动阶段缺页中断的触发次数。
首先我们打开System Trace工具:
<img src="/kw-blog/assets/img/chongpai3.68160001.png" alt="虚拟"></p> <p>我使用自己做的一个项目做测试，统计APP启动过程中产生的缺页中断次数如下：
<img src="/kw-blog/assets/img/chongpai4.652d835c.png" alt="虚拟"></p> <p>缺页中断次数:4577，耗时:760.61ms,因为该APP功能相对简单，所以可能优化空间不大，曾经拿微信的IPA包做过一个测试，发现其中断耗时达到了1.6s，当然微信的功能是非常庞大的，如果能够优化0.5s，对于用户来说也是能肉眼感受到的。接下来就讲如何通过二进制重排对APP启动时间进行优化。</p> <p>首先需要查看APP启动过程中加载了哪些类和哪些方法，这个时候XCode给我们提供了一个分析神器：LinkMAp File。
在编译阶段，每个类会生成对应的.o文件（目标文件）。在链接阶段，会把.o文件和动态库链接在一起。Link Map File就是这样一个记录链接相关信息的纯文本文件，里面记录了可执行文件的路径、CPU架构、目标文件、符号等信息。我们可以通过该文件查看启动过程中APP加载了哪些类和方法以及它们的顺序。LinkeMap不仅能用来进行二进制重排分析，也可以用来优化APP包体积。具体的使用方法以及原理参见附录。</p> <p>通过配置APP的LinkMap文件，最终我们可以看到类和方法的大致加载顺序如下(截取了一部分)：
<img src="/kw-blog/assets/img/chongpai5.6ca2987a.png" alt="虚拟"></p> <p>那么如何修改方法的加载顺序呢，XCode又提供了一个新的神器：通过设置Order File来认为干预编译期间的符号加载顺序。
当然APP启动的时候会调用大量的方法，我们不可能手写.order文件，当然还需要一个工具将这些方法按照一定的规则输出，最好是直接能生成.order文件。
目前比较通用的方法是fish hook,通过hook OC的message_send方法，输出对应的方法名，最终生成.order文件。当然这样的方法存在一些不足：如不能hook C++方法、block也hook不到。当然我们的优化不是一簇而成的。APP启动时间优化还有合并动态可、图片压缩等途径。</p> <p>参考文档:<br></p> <ul><li><a href="https://www.jianshu.com/p/52e0dee35830" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/52e0dee35830<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://blog.csdn.net/WangErice/article/details/1133492579" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/WangErice/article/details/113349257<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://blog.csdn.net/jishulaozhuanjia/article/details/104801290" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/jishulaozhuanjia/article/details/104801290<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/kw-blog/iOS/OCLint.html" class="prev">
        OClint
      </a></span> <span class="next"><a href="/kw-blog/iOS/iOSAPP重签名.html">
        iOS APP重签名
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/kw-blog/assets/js/app.b958d4e2.js" defer></script><script src="/kw-blog/assets/js/2.1e882bb7.js" defer></script><script src="/kw-blog/assets/js/4.78725ba6.js" defer></script>
  </body>
</html>
